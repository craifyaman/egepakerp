@model Kalip
@{
    string type = ViewBag.MaliyetType;
    Kalip kalip = Model;
    List<HammaddeHareket> hareketler = ViewBag.HamMaddeHareket;
    var hammaddeCinsleri = Model.KalipHammaddeRelation.Select(i => i.HammaddeCinsi);

}

@if (type == "hammadde")
{

    var hammaddeCinsi = kalip.KalipHammaddeRelation.Select(i => i.HammaddeCinsi).FirstOrDefault();
    var son12AyHammaddeHareket = hammaddeCinsi?.HammaddeHareket.Where(i => i.HammaddeGirisTarihi > DateTime.Now.AddYears(-1)).OrderByDescending(i => i.HammaddeHareketId).ToList();
    var sonHammaddeHareket = hammaddeCinsi?.HammaddeHareket.OrderByDescending(i => i.HammaddeHareketId).FirstOrDefault();
    decimal sonFaturaBirimFiyat = 0;

    //son faturayı kontrol et
    try
    {
        sonFaturaBirimFiyat = sonHammaddeHareket.BirimFiyat;
    }
    catch
    {
        sonFaturaBirimFiyat = 0;
    }

    decimal? son1AyOrtalamaBirimFiyat = null;
    decimal? son3AyOrtalamaBirimFiyat = null;
    decimal? son6AyOrtalamaBirimFiyat = null;
    decimal? son12AyOrtalamaBirimFiyat = null;


    try
    {
        son1AyOrtalamaBirimFiyat = son12AyHammaddeHareket.Where(x => x.HammaddeCinsiId != null && x.KayitTarihi >= DateTime.Now.AddMonths(-1)).GroupBy(x => new { x.HammaddeCinsiId }, (key, group) => new
        {
            HammaddeCinsiId = key.HammaddeCinsiId,
            Ortalama = group.Average(x => x.BirimFiyat)
        })?.FirstOrDefault(x => x.HammaddeCinsiId == hammaddeCinsi.HammaddeCinsiId)?.Ortalama;
    }
    catch (Exception ex)
    {

    }

    if (son1AyOrtalamaBirimFiyat == null)
    {
        son1AyOrtalamaBirimFiyat = sonFaturaBirimFiyat;
    }


    try
    {
        son3AyOrtalamaBirimFiyat = son12AyHammaddeHareket.Where(x => x.KayitTarihi >= DateTime.Now.AddMonths(-3)).GroupBy(x => new { x.HammaddeCinsiId }, (key, group) => new
        {
            HammaddeCinsiId = key.HammaddeCinsiId,
            Ortalama = group.Average(x => x.BirimFiyat)
        }).FirstOrDefault(x => x.HammaddeCinsiId == hammaddeCinsi.HammaddeCinsiId)?.Ortalama;

    }
    catch (Exception ex)
    {

    }

    if (son3AyOrtalamaBirimFiyat == null)
    {
        son3AyOrtalamaBirimFiyat = sonFaturaBirimFiyat;
    }


    try
    {
        son6AyOrtalamaBirimFiyat = son12AyHammaddeHareket.Where(x => x.KayitTarihi >= DateTime.Now.AddMonths(-6)).GroupBy(x => new { x.HammaddeCinsiId }, (key, group) => new
        {
            HammaddeCinsiId = key.HammaddeCinsiId,
            Ortalama = group.Average(x => x.BirimFiyat)
        }).FirstOrDefault(x => x.HammaddeCinsiId == hammaddeCinsi.HammaddeCinsiId)?.Ortalama;

    }
    catch (Exception ex)
    {

    }

    if (son6AyOrtalamaBirimFiyat == null)
    {
        son6AyOrtalamaBirimFiyat = sonFaturaBirimFiyat;
    }


    try
    {
        son12AyOrtalamaBirimFiyat = son12AyHammaddeHareket.Where(x => x.KayitTarihi >= DateTime.Now.AddMonths(-12)).GroupBy(x => new { x.HammaddeCinsiId }, (key, group) => new
        {
            HammaddeCinsiId = key.HammaddeCinsiId,
            Ortalama = group.Average(x => x.BirimFiyat)
        }).FirstOrDefault(x => x.HammaddeCinsiId == hammaddeCinsi.HammaddeCinsiId)?.Ortalama;

    }
    catch (Exception ex)
    {

    }


    if (son12AyOrtalamaBirimFiyat == null)
    {
        son12AyOrtalamaBirimFiyat = sonFaturaBirimFiyat;
    }



    var birimFiyat = sonHammaddeHareket?.BirimFiyat;
    var FireOran = kalip.KalipHammaddeRelation.Select(i => i.HammaddeCinsi).FirstOrDefault().HammaddeFire.Oran;
    decimal? birimMaliyet = birimFiyat != null ? ((birimFiyat * (decimal)FireOran) / 1000) * kalip.ParcaAgirlik : 0;

    <div class="form-group row parentDiv" UrunType="hammadde">
        <div class="col-lg-12 mb-2">
            <label>Hammadde Cinsi:</label>
            <select class="form-control">
                @foreach (var item in kalip.KalipHammaddeRelation.Select(i => i.HammaddeCinsi))
                {
                    <option id="@item.HammaddeCinsiId" FireOran="@item.HammaddeFire.Oran">@item.Adi</option>
                }
            </select>
        </div>
        <div class="col-lg-12 mb-2">
            <label>Birim Fiyat Tipi:</label>
            <select class="form-control" id="FiyatOrtalamaSelect" UrunType="hammadde">
                <option value="@(sonHammaddeHareket?.BirimFiyat.ToString("n2"))">Son Fatura Birim Fiyat( @(sonHammaddeHareket?.BirimFiyat.ToString("n2")) )</option>
                <option value="@son1AyOrtalamaBirimFiyat.Value.ToString("n2")">Son 1 Ay Ortalaması ( @son1AyOrtalamaBirimFiyat.Value.ToString("n2") )</option>
                <option value="@son3AyOrtalamaBirimFiyat.Value.ToString("n2")">Son 3 Ay Ortalaması ( @son3AyOrtalamaBirimFiyat.Value.ToString("n2") )</option>
                <option value="@son6AyOrtalamaBirimFiyat.Value.ToString("n2")">Son 6 Ay Ortalaması ( @son6AyOrtalamaBirimFiyat.Value.ToString("n2"))</option>
                <option value="@son12AyOrtalamaBirimFiyat.Value.ToString("n2")">Son 12 Ay Ortalaması ( @son12AyOrtalamaBirimFiyat.Value.ToString("n2") )</option>
            </select>
        </div>
        <div class="col-lg-12 mb-2">
            <label>Birim Fiyat:</label>
            <input type="text" class="form-control hesaplama" id="BirimFiyat" value="@birimFiyat" />
            <span class="form-text text-muted">kg/tl</span>

            <div class="form-group">
                <label>Mamül Ağırlık:</label>
                <input type="text" class="form-control hesaplama" id="kalipAgirlik" value="@kalip.ParcaAgirlik" />
            </div>
            <div class="form-group">
                <label>Birim Maliyet:</label>
                <input kalipId="@kalip.KalipId" type="text" class="form-control Fiyat" value="@birimMaliyet.Value.ToString("N2")" />
                <span class="form-text text-muted">( (Birim Fiyat * Fire Oranı) / 1000) * Mamül Ağırlık</span>
            </div>
        </div>
    </div>
}

@if (type == "tozBoya")
{
    try
    {
        double sabit = 12.0 / 1000.0;
        decimal KalipAgirlik = (decimal)Model.ParcaAgirlik;
        decimal KullanilanBoyaMiktar = Convert.ToDecimal(sabit) * KalipAgirlik;
        decimal BoyaBirimFiyat = TozBoyaSonBirimFiyat() / 1000;
        decimal Maliyet = KalipAgirlik * KullanilanBoyaMiktar * BoyaBirimFiyat;
        <td tozBoya-cikar="@Model.KalipId">
            <div class="form-group row parentDiv" UrunType="tozBoya">
                <div class="col-lg-12 mb-2">
                    <label>Mamül Ağırlık</label>
                    <input type="text" class="form-control" id="KalipAgirlik" value="@KalipAgirlik.ToString("n2")" disabled />
                </div>
                <div class="col-lg-12 mb-2">
                    <label>Kullanılan Boya Miktarı</label>
                    <input type="text" class="form-control hesaplama" id="BoyaMiktar" value="@KullanilanBoyaMiktar.ToString("n2")" />
                    <span class="form-text text-muted">( 12 / 1000 ) * Mamül Ağırlık</span>
                </div>
                <div class="col-lg-12 mb-2">
                    <label>Boya Birim Fiyat</label>
                    <input type="text" class="form-control" id="BirimFiyat" value="@BoyaBirimFiyat.ToString("n2")" disabled />
                </div>

                <div class="col-lg-12 mb-2">
                    <label>bir adet için üretim maliyeti:</label>
                    <input kalipId="@Model.KalipId" type="text" class="form-control Fiyat" value="@Maliyet.ToString("n2")" />
                    <span class="form-text text-muted">Mamül Ağırlık * Boya Miktarı * Birim Fiyat</span>
                </div>
            </div>
        </td>
    }
    catch (Exception ex)
    {

    }
}

@if (type == "koli")
{
    <tr>
        <td koli-cikar="@kalip.KalipId">
            <div class="form-group row parentDiv" UrunType="koli">
                <div class="col-lg-12 mb-2">
                    <label>Bant :</label>
                    <select class="form-control" id="BantSelect">
                        @foreach (var bant in BaseHammaddeHareketler("bant"))
                        {
                            <option value="@bant.BirimFiyat">@bant.UrunAdi - (@bant.BirimFiyat @bant.Doviz.Kisaltma)</option>
                        }
                    </select>
                </div>
                <div class="col-lg-12 mb-2">
                    <label>Koli Türü:</label>
                    <select class="form-control" id="KoliBirimFiyat">
                        @{
                            HammaddeHareket KoliSonHareket = KoliSohHareket();
                            var KoliBirimFiyat = KoliSonHareket?.BirimFiyat;

                            decimal? KoliBirimMaliyet = KoliBirimFiyat != null ? (KoliBirimFiyat / 1500) : 0;
                            string PosetParametre = ViewBag.PosetParametre;
                            var _list = BaseSarfMalzeme().Where(x => x.UrunAdi.ToLower().Contains("koli") && !x.UrunAdi.ToLower().Contains("bantı")).ToList();
                            decimal Katsayi = 0;
                            try
                            {
                                Katsayi = KoliSonHareket.UrunAdi.Contains("43*34*30") ? 0.03M : 0.04M;
                            }
                            catch { }

                        }

                        @foreach (var item in _list)
                        {
                            if (item.UrunAdi.Contains(" 60*40*40 "))
                            {
                                PosetParametre = "0.060";
                                Katsayi = 0.04M;
                            }
                            else if (item.UrunAdi.Contains("43*34*30"))
                            {
                                PosetParametre = "0.036";
                                Katsayi = 0.03M;
                            }
                            <option value="@item.BirimFiyat" posetParametre="@PosetParametre" Katsayi="@Katsayi">@(item.UrunAdi) (@item.BirimFiyat)</option>
                        }
                    </select>
                </div>
                <div class="col-lg-12 mb-2">

                    @{
                        var birimFiyat = ViewBag.KoliSonBirimFiyat;
                        //decimal koliBandiEkMaliyet = 0.001M;
                        decimal? birimMaliyet = birimFiyat != null ? (birimFiyat * Katsayi) / 1500 : 0;
                    }
                    <label>Birim Fiyat:</label>
                    <input type="text" class="form-control hesaplama" id="BirimFiyat" value="@birimFiyat" disabled />
                </div>
                <input type="hidden" id="posetParametre" targetInputId="PosetParametre_@Model.KalipId" value="@PosetParametre" />

                <div class="col-lg-12 mb-2">
                    <label>Katsayı:</label>
                    <input type="text" class="form-control hesaplama" id="KoliKatsayi" value="@Katsayi" />
                </div>

                @*<div class="col-lg-12 mb-2">
                        <label>Mamül Ağırlık:</label>
                        <input type="text" class="form-control" id="KalipAgirlik" value="@kalip.ParcaAgirlik" disabled />
                    </div>*@
                <div class="col-lg-12 mb-2">
                    <label>Koli Kapasitesi:</label>
                    <input type="text" class="form-control hesaplama" id="Kapasite" value="1500" />
                </div>
                <div class="col-lg-12 mb-2">
                    <label>Birim Maliyet:</label>
                    <input kalipId="@Model.KalipId" type="text" class="form-control Fiyat" value="@birimMaliyet.Value.ToString("N4")" />
                    <span class="form-text text-muted">(BantFiyat * Katsayi + BirimFiyat) / Kapasite</span>
                </div>
            </div>
        </td>
    </tr>
}

@if (type == "poset")
{
    <div class="form-group row parentDiv" UrunType="poset">
        <div class="col-lg-12 mb-2">
            <label>Poşet Türü:</label>
            <select class="form-control" id="PosetBirimFiyat">
                @foreach (var item in BaseSarfMalzeme().Where(x => x.UrunAdi.ToLower().Contains("poşet")))
                {
                    <option value="@item.BirimFiyat">@(item.UrunAdi) (@item.BirimFiyat)</option>
                }
            </select>
        </div>
        <div class="col-lg-12 mb-2">
            @{
                decimal? birimFiyat = ViewBag.PosetSonBirimFiyat;
                decimal Katsayi = Convert.ToDecimal(ViewBag.PosetParametre) / 1000;
                decimal? birimMaliyet = birimFiyat != null ? (birimFiyat * Katsayi) / 1500 : 0;
            }
            <label>Birim Fiyat:</label>
            <input type="text" class="form-control hesaplama" id="BirimFiyat" value="@birimFiyat" disabled />
        </div>

        <div class="col-lg-12 mb-2">
            <label>Katsayı:</label>
            <input type="text" class="form-control hesaplama" value="@ViewBag.PosetParametre" id="PosetKatsayi" />
        </div>

        <div class="col-lg-12 mb-2">
            <label>Mamül Ağırlık:</label>
            <input type="text" class="form-control hesaplama" id="KalipAgirlik" value="@kalip.ParcaAgirlik" disabled />
        </div>

        <div class="col-lg-12 mb-2">
            <label>Peşet Kapasitesi:</label>
            <input type="text" class="form-control" id="Kapasite" value="1500" />
        </div>

        <div class="col-lg-12 mb-2">
            <label>Birim Maliyet:</label>
            <input kalipId="@kalip.KalipId" type="text" class="form-control Fiyat" value="@birimMaliyet.Value.ToString("N4")" />
            <span class="form-text text-muted">(Birim Fiyat * @ViewBag.PosetParametre) / Kapasite</span>
        </div>

    </div>
}

@if (type == "yaldiz")
{
    <tr>
        @{
            List<HammaddeHareket> Malzemeler = BaskiMalzemeler();

            double BirimFiyat = Convert.ToDouble(Malzemeler.FirstOrDefault()?.BirimFiyat);
            double Maliyet = (BirimFiyat * 40) / 10000;
        }
        <td yaldiz-cikar="@kalip.KalipId">
            <div class="parentDiv" UrunType="yaldiz">
                <div class="col-lg-12 mb-2">
                    <label>Malzeme:</label>
                    <select class="form-control" id="yaldizSelect">
                        @foreach (var item in Malzemeler)
                        {
                            <option value="@item.BirimFiyat">@item.UrunAdi ( @item.BirimFiyat TL )</option>
                        }
                    </select>

                </div>
                <div class="col-lg-12 mb-2">
                    <label>Birim Fiyat:</label>
                    <input type="text" class="form-control hesaplama" id="BirimFiyat" value="@BirimFiyat.ToString("n2")" disabled />
                </div>
                <div class="col-lg-12 mb-2">
                    <label>Kat Sayı:</label>
                    <input type="text" class="form-control hesaplama" id="KatSayi" value="40" />
                </div>
                <div class="col-lg-12 mb-2">
                    <label>Birim Maliyet:</label>
                    <input kalipId="@kalip.KalipId" type="text" class="form-control Fiyat" value="@Maliyet.ToString("n2")" />
                    <span class="form-text text-muted">(BirimFiyat * Kat Sayı) / 10000</span>
                </div>
            </div>

        </td>
    </tr>
}

@if (type == "enjeksiyon")
{
    try
    {
        double enjeksiyonSaatMaliyet = 100;
        double birAdetUrunUretimMaliyeti = ((3600 / (int)kalip.UretimZamani) * (int)kalip.KalipGozSayisi) / enjeksiyonSaatMaliyet;

        <div class="form-group row parentDiv" UrunType="enjeksiyon">
            <div class="col-lg-12 mb-2">
                <label>enjeksiyon saat maliyet</label>
                <input type="text" class="form-control hesaplama" id="SaatMaliyet" value="@enjeksiyonSaatMaliyet" />
            </div>
            <div class="col-lg-12 mb-2">
                <label>Üretim Zamanı:</label>
                <input type="text" class="form-control hesaplama" id="UretimZamani" value="@kalip.UretimZamani" disabled />
            </div>

            <div class="col-lg-12 mb-2">
                <label>Göz Sayısı:</label>
                <input type="text" class="form-control hesaplama" id="GozSayisi" value="@kalip.KalipGozSayisi" disabled />
            </div>
            <div class="col-lg-12 mb-2">
                <label>bir adet için üretim maliyeti</label>
                <input kalipId="@kalip.KalipId" type="text" class="form-control Fiyat" value="@birAdetUrunUretimMaliyeti.ToString("N2")" placeholder="(3600/üretim zamanı)*(göz sayısı/enjeksiyon saat maliyet)" />
                <span class="form-text text-muted">( (3600/üretim zamanı) * göz sayısı ) / ( enjeksiyon saat maliyet )</span>
            </div>
        </div>

    }
    catch (Exception ex)
    {

        <div class="form-group row parentDiv" UrunType="enjeksiyon">
            <div class="col-lg-12 mb-2">
                <label>enjeksiyon saat maliyet</label>
                <input type="text" class="form-control hesaplama" id="SaatMaliyet" value="" />
            </div>
            <div class="col-lg-12 mb-2">
                <label>Üretim Zamanı:</label>
                <input type="text" class="form-control hesaplama" id="UretimZamani" value="@kalip.UretimZamani" disabled />
            </div>

            <div class="col-lg-12 mb-2">
                <label>Göz Sayısı:</label>
                <input type="text" class="form-control hesaplama" id="GozSayisi" value="@kalip.KalipGozSayisi" disabled />
            </div>
            <div class="col-lg-12 mb-2">
                <label>bir adet için üretim maliyeti</label>
                <input kalipId="@kalip.KalipId" type="text" class="form-control Fiyat" value="" placeholder="(3600/üretim zamanı)*(göz sayısı/enjeksiyon saat maliyet)" />
                <span class="form-text text-muted">( (3600/üretim zamanı) * göz sayısı ) / ( enjeksiyon saat maliyet )</span>
            </div>
        </div>

    }
}

@if (type == "sicakbaski")
{
    <tr>
        @try
        {
            double SicakBaskiTamponSaatAdet = 300;
            double SicakBaskiTamponSaatMaliyet = 35;
            double birimSicakBaskiTamponMaliyet = SicakBaskiTamponSaatMaliyet / SicakBaskiTamponSaatAdet;
            <td sicakBaski-cikar="@kalip.KalipId">
                <div class="form-group row parentDiv" UrunType="sicakbaski">
                    <div class="col-lg-12 mb-2">
                        <label>sıcak baskı tampon saat adet</label>
                        <input type="text" class="form-control hesaplama" id="SaatAdet" value="@SicakBaskiTamponSaatAdet" />
                    </div>
                    <div class="col-lg-12 mb-2">
                        <label>sıcak baskı tampon saat maliyet</label>
                        <input type="text" class="form-control hesaplama" id="SaatMaliyet" value="@SicakBaskiTamponSaatMaliyet" />
                    </div>
                    <div class="col-lg-12 mb-2">
                        <label>birim sıcak baskı tampon maliyet</label>
                        <input kalipId="@kalip.KalipId" type="text" class="form-control Fiyat" value="@birimSicakBaskiTamponMaliyet.ToString("N2")" placeholder="saat maliyet/adet" />
                        <span class="form-text text-muted">saat maliyet/adet</span>
                    </div>
                </div>

            </td>
        }
        catch (Exception ex)
        {

        }
    </tr>
}

@if (type == "montaj")
{
    <tr>
        @try
        {
            double PersonelSaatMaliyet = 35;
            double SaatlikUretimAdet = 300;
            double Maliyet = PersonelSaatMaliyet / SaatlikUretimAdet;
            <td montaj-cikar="@kalip.KalipId">
                <div class="form-group row parentDiv" UrunType="montaj">
                    <div class="col-lg-12 mb-2">
                        <label>saatlik üretim adedi</label>
                        <input type="text" class="form-control hesaplama" id="SaatAdet" value="@SaatlikUretimAdet" />
                    </div>
                    <div class="col-lg-12 mb-2">
                        <label>Personel Saat Maliyet</label>
                        <input type="text" class="form-control hesaplama" id="SaatMaliyet" value="@PersonelSaatMaliyet" />
                    </div>
                    <div class="col-lg-12 mb-2">
                        <label>aded maliyeti</label>
                        <input kalipId="@kalip.KalipId" type="text" class="form-control Fiyat" value="@Maliyet.ToString("N2")" />
                        <span class="form-text text-muted">Personel Saat Maliyet / Saatlik Üretim Adedi</span>
                    </div>
                </div>

            </td>
        }
        catch (Exception ex)
        {

        }
    </tr>
}